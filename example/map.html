<!doctype html>
<html>
  <head>
    <title>stravanova</title>

    <!-- HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
    <script src="//html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <style>

      body{
        font-family: 'Droid Sans', 'Helvetica', Arial, sans-serif;
        margin:5px;
      }

      #map{
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 0;
      }
    </style>

  </head>

  <body>
    <div id='map'>
    </div>

  </body>

  <!-- jquery from cdn with local fallback -->
  <script src='//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script>
  <script>
    if (typeof jQuery == 'undefined') {
      document.write(unescape("%3Cscript src='js/jquery.min.js' type='text/javascript'%3E%3C/script%3E"));
    }
  </script>

  <!-- underscore sans fallback; should use require.js -->
  <script src='//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.3.3/underscore-min.js'></script>

  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript" src="js/gmaps.js"></script>

  <script>

    var Route_Player = function(route, map) {
      this.route = route;
      this.map = map
      this.current_frame = 0;

      this.play = function() {
        var self = this;
        this.timeout_id = window.setInterval( function() {
          self.animate_frame();
        }, 100);
      };

      this.pause = function() {
        window.clearTimeout(this.timeout_id);
      };

      this.animate_frame = function() {
        // remove old marker
        if (this.current_marker) {
          this.current_marker.setMap(null);
        }

        this.current_marker = this.map.addMarker({
          lat: this.route[this.current_frame][0]
          , lng: this.route[this.current_frame][1]
        });

        this.current_frame++;
      };

    };

    var map;

    $(function() {
      map = new GMaps({
        div: '#map'
        , lat: 37.90625
        , lng: -122.45464
        , zoom: 11
      });

      $.getJSON('rides.json', function(data) {
        _.map(data, function(route) {
          var path = _.map(route, function(point) { return [point[0], point[1]] });

          map.drawPolyline({
            path: path
            , strokeColor: '#1C86FF'
          });

          var player = new Route_Player(route, map);
          player.play();

        });
      });

    });

  </script>

</html>
